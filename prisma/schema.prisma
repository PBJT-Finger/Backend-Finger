// This is your Prisma schema file for Backend-Finger project
// Migrated from Sequelize to Prisma ORM
// Database: MySQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =====================================================
// ADMIN USER MODEL
// =====================================================
model Admin {
  id            Int              @id @default(autoincrement())
  username      String           @unique @db.VarChar(50)
  password_hash String           @db.VarChar(255)
  email         String?          @db.VarChar(100)
  role          String           @default("admin") @db.VarChar(50)
  is_active     Boolean          @default(true)
  last_login    DateTime?
  created_at    DateTime         @default(now())
  updated_at    DateTime         @updatedAt

  // Relations
  passwordResets PasswordReset[]

  @@index([username])
  @@index([role])
  @@index([is_active])
  @@map("admins")
}

// =====================================================
// PASSWORD RESET MODEL
// =====================================================
model PasswordReset {
  id           Int       @id @default(autoincrement())
  admin_id     Int
  email        String    @db.VarChar(255)
  code         String    @db.VarChar(6)
  reset_token  String?   @db.VarChar(255)
  expires_at   DateTime
  used_at      DateTime?
  created_at   DateTime  @default(now())

  // Relations
  admin Admin @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([code])
  @@index([reset_token])
  @@index([expires_at])
  @@index([admin_id])
  @@map("password_resets")
}

// =====================================================
// SHIFT MODEL
// =====================================================
model Shift {
  id              Int       @id @default(autoincrement())
  nama_shift      String    @db.VarChar(50)
  jam_masuk       DateTime  @db.Time()
  toleransi_menit Int       @default(0)
  deskripsi       String?   @db.Text
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relations
  employees Employee[]

  @@index([is_active])
  @@map("shifts")
}

// =====================================================
// EMPLOYEE MODEL
// =====================================================
enum Jabatan {
  DOSEN
  KARYAWAN
}

enum StatusPegawai {
  AKTIF
  CUTI
  RESIGN
  NON_AKTIF
}

model Employee {
  id             Int            @id @default(autoincrement())
  nip            String         @unique @db.VarChar(50)
  nama           String         @db.VarChar(255)
  jabatan        Jabatan
  department     String?        @db.VarChar(100)
  fakultas       String?        @db.VarChar(100)
  email          String?        @db.VarChar(100)
  phone          String?        @db.VarChar(20)
  shift_id       Int?
  status         StatusPegawai  @default(AKTIF)
  tanggal_masuk  DateTime?      @db.Date
  is_active      Boolean        @default(true)
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt

  // Relations
  shift      Shift?       @relation(fields: [shift_id], references: [id], onDelete: SetNull)
  attendance Attendance[]

  @@index([nip])
  @@index([jabatan])
  @@index([shift_id])
  @@index([status])
  @@index([is_active])
  @@map("employees")
}

// =====================================================
// ATTENDANCE MODEL
// =====================================================
model Attendance {
  id          Int       @id @default(autoincrement())
  user_id     String    @db.VarChar(50) // This maps to employee.nip
  nip         String    @db.VarChar(50)
  nama        String    @db.VarChar(255)
  jabatan     Jabatan
  tanggal     DateTime  @db.Date
  jam_masuk   DateTime? @db.Time()
  jam_keluar  DateTime? @db.Time()
  device_id   String?   @db.VarChar(100)
  status      String    @default("HADIR") @db.VarChar(50)
  keterangan  String?   @db.Text
  is_deleted  Boolean   @default(false)
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt

  // Relations
  employee Employee? @relation(fields: [nip], references: [nip], onDelete: Cascade)
  device   Device?   @relation(fields: [device_id], references: [device_id], onDelete: SetNull)

  @@index([nip])
  @@index([tanggal])
  @@index([is_deleted])
  @@index([nip, tanggal])
  @@index([device_id])
  @@index([user_id])
  @@map("attendance")
}

// =====================================================
// DEVICE MODEL
// =====================================================
model Device {
  id           Int          @id @default(autoincrement())
  device_name  String       @db.VarChar(100)
  device_id    String       @unique @db.VarChar(100)
  location     String?      @db.VarChar(255)
  api_key_hash String       @db.VarChar(255)
  is_active    Boolean      @default(true)
  created_at   DateTime     @default(now())
  updated_at   DateTime     @updatedAt

  // Relations
  attendance Attendance[]

  @@index([device_id])
  @@index([is_active])
  @@map("devices")
}

